{% extends "base.html" %}
{% block title %}Live Authentication - {{ exam.subject }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="text-center">Live Authentication: {{ exam.subject }}</h2>
            <p class="text-center text-muted">Date: {{ exam.date.strftime('%Y-%m-%d') }} | Time: {{ exam.start_time.strftime('%H:%M') }} - {{ exam.end_time.strftime('%H:%M') }}</p>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div id="video-feed-container" class="embed-responsive embed-responsive-16by9" style="background-color: #333;">
                {# The video feed will be loaded here by the <img> tag pointing to /video_feed/<exam_id> #}
                <img id="videoFeed" src="{{ url_for('main.video_feed', exam_id=exam.id) }}" class="embed-responsive-item" alt="Live Camera Feed">
            </div>
            <div id="statusMessages" class="mt-3">
                {# Status messages like "Student X verified" could appear here, though they are often drawn on the video feed itself #}
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12 text-center">
            <a href="{{ url_for('main.select_exam_for_auth') }}" class="btn btn-secondary">
                <i class="fas fa-stop-circle"></i> End Session & Select Another Exam
            </a>
             <button id="refreshLiveAuthFacesBtn" class="btn btn-info ml-2">
                <i class="fas fa-sync"></i> Refresh Known Faces (Live)
            </button>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-12">
            <h4>Recent Verifications for this Session:</h4>
            <ul id="recentLogsList" class="list-group">
                <!-- Logs will be dynamically added here if implemented -->
            </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const videoFeedImg = document.getElementById('videoFeed');
    const statusMessagesDiv = document.getElementById('statusMessages');

    // Optional: If your video feed route has issues, this can help debug or show a placeholder
    videoFeedImg.onerror = function() {
        statusMessagesDiv.innerHTML = '<div class="alert alert-danger">Error loading video feed. Ensure camera is connected and server is running correctly.</div>';
        videoFeedImg.style.display = 'none'; // Hide broken image icon
    };

    // Function to refresh known faces from this page
    const refreshLiveAuthButton = document.getElementById('refreshLiveAuthFacesBtn');
    if(refreshLiveAuthButton) {
        refreshLiveAuthButton.addEventListener('click', function() {
            fetch("{{ url_for('main.refresh_face_cache') }}", {
                method: 'POST',
                headers: {
                    // 'X-CSRFToken': '{{ csrf_token() }}' // If CSRF needed
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || "Cache refresh initiated.");
                 if(data.status === "success") {
                    console.log("Face cache refreshed. Loaded " + data.faces_loaded + " faces.");
                    statusMessagesDiv.innerHTML = `<div class="alert alert-success">Known faces cache refreshed. ${data.faces_loaded} faces loaded.</div>`;
                } else {
                    console.error("Face cache refresh failed: ", data.message);
                    statusMessagesDiv.innerHTML = `<div class="alert alert-danger">Face cache refresh failed: ${data.message}</div>`;
                }
                setTimeout(() => { statusMessagesDiv.innerHTML = ''; }, 5000);
            })
            .catch(error => {
                console.error('Error initiating face cache refresh:', error);
                alert('Error initiating cache refresh. See console for details.');
                statusMessagesDiv.innerHTML = `<div class="alert alert-danger">Error initiating cache refresh.</div>`;
                setTimeout(() => { statusMessagesDiv.innerHTML = ''; }, 5000);
            });
        });
    }

    // TODO: Consider WebSocket for real-time log updates on this page if needed,
    // instead of just relying on names appearing on video.
    // For now, recent logs list is static.
});
</script>
{% endblock %}
